---
title: Estimating Transaction Costs on OP Stack
lang: en-US
description: Learn how to use the Viem/op-stack to estimate the cost of a transaction on OP Mainnet.
---

import { Callout, Steps, Tabs } from 'nextra/components'

# Estimating Transaction Costs on OP Stack

In this tutorial, you'll learn how to use the [Viem](https://viem.sh/op-stack/) to estimate the cost of a transaction on OP Mainnet.
You'll learn how to estimate the [execution gas fee](/builders/app-developers/transactions/fees#execution-gas-fee) and the [L1 data fee](/builders/app-developers/transactions/fees#l1-data-fee) independently.
You'll also learn how to estimate the total cost of the transaction all at once.

<Callout>
  Check out the full explainer on [OP Stack transaction fees](/builders/app-developers/transactions/fees) for more information on how OP Mainnet charges fees under the hood.
</Callout>

## Supported Networks

Viem supports any of the [Superchain networks](/chain/networks).
The OP Stack networks are included in Viem by default.
If you want to use a network that isn't included by default, you can add it to Viem's chain configurations.

## Dependencies

*   [node](https://nodejs.org/en/)
*   [pnpm](https://pnpm.io/installation)

## Create a Demo Project

You're going to use Viem for this tutorial.
Since Viem is a [Node.js](https://nodejs.org/en/) library, you'll need to create a Node.js project to use it.

<Steps>
  {<h3>Make a Project Folder</h3>}

  ```bash
  mkdir op-sample-project
  cd op-sample-project
  ```

  {<h3>Initialize the Project</h3>}

  ```bash
  pnpm init
  ```

  {<h3>Install the viem library</h3>}

  ```bash
  pnpm add viem
  ```
</Steps>

<Callout type="info">
  Want to create a new wallet for this tutorial?
  If you have [`cast`](https://book.getfoundry.sh/getting-started/installation) installed you can run `cast wallet new` in your terminal to create a new wallet and get the private key.
</Callout>

## Get ETH on Sepolia

This tutorial explains how to bridge ETH from Sepolia to OP Sepolia.
You will need to get some ETH on Sepolia to follow along.

<Callout type="info">
  You can use [this faucet](https://sepoliafaucet.com) to get ETH on Sepolia.
</Callout>

## Add a Private Key to Your Environment

You need a private key in order to sign transactions.
Set your private key as an environment variable with the export command.
Make sure this private key corresponds to an address that has ETH on Sepolia.

```bash
export TUTORIAL_PRIVATE_KEY=0x...
```

## Start the Node REPL

You're going to use the Node REPL to interact with Viem.
To start the Node REPL run the following command in your terminal:

```bash
node
```

This will bring up a Node REPL prompt that allows you to run JavaScript code.


## Get ETH on OP Sepolia

This tutorial explains how estimate transaction costs on OP Sepolia.
You will need to get some ETH on OP Sepolia in order to run the code in this tutorial.

<Callout type="info">
  You can use the [Superchain Faucet](https://console.optimism.io/faucet?utm_source=docs) to get ETH on OP Sepolia.
</Callout>

This will bring up a Node REPL prompt that allows you to run javascript code.

## Set Session Variables

You'll need a few variables throughout this tutorial.
Let's set those up now.

<Steps>

{<h3>Import Viem and other necessary modules</h3>}

```js

const { createPublicClient, createWalletClient, http, parseEther, parseGwei, formatEther } = require('viem');
const { privateKeyToAccount } = require('viem/accounts');
const { optimismSepolia } = require('viem/chains');
const { publicActionsL2, walletActionsL2 } = require('viem/op-stack');
```

{<h3>Set up the account</h3>}

```js
const account = privateKeyToAccount(process.env.TUTORIAL_PRIVATE_KEY);
```
{<h3>Create the public client</h3>}

```js
const publicClientL2 = createPublicClient({
  chain: optimismSepolia,
  transport: http("https://sepolia.optimism.io"),
}).extend(publicActionsL2());
```

{<h3>Create the wallet client</h3>}

```js
const walletClientL2 = createWalletClient({
  chain: optimismSepolia,
  transport: http("https://sepolia.optimism.io"),
}).extend(walletActionsL2());
```
</Steps>

## Estimate Transaction Costs

You're now going to estimate the cost of a transaction on OP Mainnet.

<Steps>
  {<h3>Define the transaction</h3>}

  Viem makes it easy to prepare a transactions so you can estimate the cost of a transaction before you sign it.
  Here you'll define an object with the required transaction fields and send a small amount of ETH from your address to the address `0x1000000000000000000000000000000000000000`.

  ```js
      const transaction = {
      account,
      to: '0x1000000000000000000000000000000000000000',
      value: parseEther('0.005'),  
      gasPrice: parseGwei('20')
    };
  ```
  This transaction will send `0.005` ETH to the specified address with a gas price of 20 Gwei.

  {<h3>Estimate the execution gas fee</h3>}

  Now, let's estimate the gas limit for our transaction.

  ```js
      const gasLimit = await publicClientL2.estimateGas(transaction);
      console.log(`Estimated Gas Limit: ${gasLimit}`);
  ```

  <Steps>
    {<h3>Retrieve the current gas price</h3>}

    Retrieve the current gas price (effective gas price), Alternatively, given that you already set the gas price manually, you can use the `getGasPrice` method from viem.

    ```js
    const effectiveGasPrice = await publicClientL2.getGasPrice();
    console.log(`effective Gas Price, ${effectiveGasPrice}`);
    ```

    {<h3>Calculate the execution gas fee</h3>}

    To calculate the execution gas fee simply multiply the gas limit by the effective gas price.

    ```js
    const l2CostEstimate = gasLimit * effectiveGasPrice;
    console.log(`Estimated Execution Gas Fee: ${formatEther(l2CostEstimate)}`);
    ```
  </Steps>

  {<h3>Estimate the L1 data fee</h3>}

  You can estimate the L1 data fee with the [estimateL1GasCost](https://viem.sh/op-stack/actions/estimateL1Gas) function.
  Under the hood, this function is estimating the amount of Ethereum gas required to publish this transaction on Ethereum and multiplying it by the current Ethereum gas price (as tracked by the L2).
  This function returns the current cost estimate in wei.

  ```js
  const l1CostEstimate = await publicClientL2.estimateL1Fee(transaction)
  console.log(`Estimated L1 data Fee: ${formatEther(l1CostEstimate)}`);
  ```

  {<h3>Estimate the total cost</h3>}

  Once you've individually estimated the execution gas fee and the L1 data fee, you can sum these two values together to get the total cost of the transaction.

  ```js
    const totalEstimate = l2CostEstimate + l1CostEstimate;
    console.log(`Estimated Total Cost: ${formatEther(totalEstimate)} `);
  ```

  {<h3>Send the transaction</h3>}

  Now that you've estimated the total cost of the transaction, go ahead and send it to the network.
  This will make it possible to see the actual cost of the transaction to compare to your estimate.

  ```js
      const txHash = await walletClientL2.sendTransaction(transaction)
      console.log(`Transaction Hash: ${txHash}`);
  ```

  {<h3>Check the actual execution gas fee</h3>}

  Once you get back the transaction receipt, check the actual execution gas fee.
  You can do so by accessing the `gasUsed` and `effectiveGasPrice` from the transaction receipt.
  You can then multiply these values to get the actual L2 cost of the transaction

  ```js
      const receipt = await publicClientL2.getTransactionReceipt({ hash: txHash });
      console.log('Transaction receipt:', receipt);

      const l2CostActual = receipt.gasUsed * receipt.effectiveGasPrice;
      console.log(`L2 Actual Cost: ${formatEther(l2CostActual)}`);
  ```

  {<h3>Check the actual L1 data fee</h3>}

  You can also check the actual L1 data fee.

  ```js
    const l1CostActual = await publicClientL2.estimateL1Fee(txHash)
    console.log(`l1CostActual gas fee: ${formatEther(l1CostActual)}`);

  ```

  {<h3>Check the actual total cost</h3>}

  Sum these two together to get the actual total cost of the transaction.

  ```js
      const totalActual = l2CostActual + l1CostActual;
      console.log(`Total Actual Cost: ${formatEther(totalActual)}`);
  ```

  {<h3>Check the difference</h3>}

  Finally, check the difference between the estimated total cost and the actual total cost.
  This will give you a sense of how accurate your estimate was.
  Estimates will never be entirely accurate, but they should be close!

  ```js
      const difference = totalEstimate >= totalActual ? totalEstimate - totalActual : totalActual - totalEstimate
    console.log(`Estimation Difference: ${formatEther(difference)} ETH`)
  ```
</Steps>

<Callout type="info">
Estimates will never be entirely accurate due to network conditions and gas price fluctuations, but they should be close to the actual costs.
</Callout>

## Next Steps

*   Always estimate before sending: Estimating costs before sending a transaction helps prevent unexpected fees and failed transactions.
*   Account for gas price volatility: Gas prices can change rapidly. Consider adding a buffer to your estimates or implementing a gas price oracle for more accurate pricing.
*   Optimize transaction data: Minimize the amount of data in your transactions to reduce L1 data fees.
*   Monitor network conditions: Keep an eye on network congestion and adjust your estimates accordingly.
*   Use appropriate gas limits: Setting too low a gas limit can cause transactions to fail, while setting it too high can result in unnecessary costs.
*   Implement retry mechanisms: If a transaction fails due to underestimated gas, implement a retry mechanism with adjusted gas parameters.
